<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>

		<title>lrkwz/jCryptionSpring @ GitHub</title>

		<style type="text/css">
			body {
				margin-top: 1.0em;
				background-color: #ffffff;
				font-family: Helvetica, Arial, FreeSans, san-serif;
				color: #000000;
			}
			#container {
				margin: 0 auto;
				width: 700px;
			}
			h1 { font-size: 3.8em; color: #000000; margin-bottom: 3px; }
			h1 .small { font-size: 0.4em; }
			h1 a { text-decoration: none }
			h2 { font-size: 1.5em; color: #000000; }
			h3 { text-align: center; color: #000000; }
			a { color: #000000; }
			.description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
			.download { float: right; }
			pre { background: #000; color: #fff; padding: 15px;}
			hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
			.footer { text-align:center; padding-top:30px; font-style: italic; }
		</style>
		<link href='http://alexgorbatchev.com/pub/sh/current/styles/shCore.css' rel='stylesheet' type='text/css'/>
		<link href='http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/>
		<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js' type='text/javascript'><!-- --></script>
		<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js' type='text/javascript'><!-- --></script>
		<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPlain.js' type='text/javascript'><!-- --></script>
		<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js' type='text/javascript'><!-- --></script>
		<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js' type='text/javascript'><!-- --></script>
	</head>

	<body>
		<a href="http://github.com/lrkwz/jCryptionSpring"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>

		<div id="container">

<h1>jCryption for Spring</h1>

<p>Use this module to implement a client-server JavaScript to Java based encryption system without the need <sic> of SSL.
This library requires the use of jCryption (http://www.jcryption.org) a JavaScript/PHP framework based on jQuery.</p>

<p>The objectives for this springframework integration module are:</p>

<ul>
<li>get rid of the PHP component</li>
<li>do not inject (decouple) decrypting code into the standard mvc controllers</li>
</ul>

<p>The framework implements the following process:</p>

<ol>
<li>the javascript hook calls the jCryptionSpring server side controller to obtain the encryption public key before the POST</li>
<li>the javascript library crypts all the form's parameters into a single string which is POSTed to the standard user defined controller</li>
<li>a filter intercepts all the calls which contain the crypted variable and decrypts it to it's original values; the original request is wrapped in order to provide the same parameters back to the standard user defined controller ad if the POST hasn't been crypted at all (100% transparent to yuor code!)</li>
<li>from this point on the filter chain is executed as usual</li>
</ol>

<p>In this way you can build a standard spring mvc application inserting form crypting only where you need it; let's try it step by step using spring roo (not necessary but quite useful even for this small sample):</p>

<p>execute this commands in roo shell in order to quicky startup a web app to create/show/modify a simple UserProfile object</p>

<script type="syntaxhighlighter" class="brush: plain"><![CDATA[
project --topLevelPackage org.gitorious.jcryptionspring.sample
persistence setup --database HYPERSONIC_IN_MEMORY --provider HIBERNATE 
entity --class ~domain.UserProfile
field string --class ~domain.UserProfile --fieldName email
field string --class ~domain.UserProfile --fieldName name
field string --class ~domain.UserProfile --fieldName surname
field date --class ~domain.UserProfile --fieldName birthday --type java.util.Calendar
field boolean --class ~domain.UserProfile --fieldName enabled
logging setup --level DEBUG 
controller scaffold --class ~.web.UserProfileController 
security setup
dependency add --artifactId jcryption-spring --groupId org.gitorious.jcryptionspring --version 0.1.2 
quit
]]></script>

<p>this script also appends in pom.xml the dependency from the integration module</p>

<script type="syntaxhighlighter" class="brush: xml"><![CDATA[
&lt;dependency&gt;
            &lt;groupId&gt;org.gitorious.jcryptionspring&lt;/groupId&gt;
            &lt;artifactId&gt;jcryption-spring&lt;/artifactId&gt;
            &lt;version&gt;0.1.2&lt;/version&gt;
&lt;/dependency&gt;
]]></script>

<p>now we should add the javascript libraries; dowload them from jCryption zip package on Google code(http://code.google.com/p/jcryption/downloads/list) or source code on github (https://github.com/HazAT/jCryption)</p>

<p>Change your layout file  src/main/webapp/WEB-INF/layouts/default.jspx in order to include js libraries in every page </p>

<script type="syntaxhighlighter" class="brush: js"><![CDATA[
<spring:url var="home" value="/" /></p>

<script src="${home }js/jquery-1.4.2.min.js" type="text/javascript"><!--  -->&lt;/script>  
<script src="${home }js/jquery-ui-1.8.2.custom.min.js" type="text/javascript"><!--  -->&lt;/script>  
<script type="text/javascript"    src="${home }js/security/jquery.jcryption-1.2.js"><!--  -->&lt;/script>
]]></script>

Then hook the cryptong function to each form you want to alter (e.g. src/main/webapp/WEB-INF/views/userprofiles/create.jspx and/or src/main/webapp/WEB-INF/views/userprofiles/update.jspx) adding (alter it to accommodate the correct form id):

<script type="syntaxhighlighter" class="brush: JScript"><![CDATA[
<spring:url value="/EncryptionServlet?generateKeypair=true"  var="getKeysURL"/>
<script>  
/*<![CDATA[ */  

$(function() {

$("#userProfile").jCryption({getKeysURL:"${getKeysURL}"});

});
/*]]>*/
&lt;/script> 

]]></script>

<p>To catch the /EncryptionServlet call you can add the following lines in the mvc configuration src/main/webapp/WEB-INF/spring/webmvc-config.xml:</p>

<script type="syntaxhighlighter" class="brush: xml"><![CDATA[
&lt;context:component-scan base-package="org.gitorious.jcryptionspring"&gt;
&lt;/context:component-scan&gt;
]]></script>

<p>and now we must configure the servlet decrypting in src/main/webapp/WEB-INF/web.xml</p>

<script type="syntaxhighlighter" class="brush: xml"><![CDATA[
&lt;filter&gt;
    &lt;filter-name&gt;DecryptParameters&lt;/filter-name&gt; <br />
    &lt;filter-class&gt;org.gitorious.jcryptionspring.ParameterDecryptingFilter&lt;/filter-class&gt; <br />
&lt;/filter&gt; <br />
&lt;filter-mapping&gt; <br />
    &lt;filter-name&gt;DecryptParameters&lt;/filter-name&gt; <br />
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt; <br />
&lt;/filter-mapping&gt;
]]></script>

<p>this should be added before the CharacterEncodingFilter in order to maintain the filters order correct (the Spring OpenEntityManagerInViewFilter must stay in place to avoid  "Detached entry passed to persist" error)</p>

<p>Easy isn't it? ;-)</p>
		</div>


		<script type="text/javascript">

			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-25872251-1']);
			_gaq.push(['_trackPageview']);

			(function() {
			 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			 })();
		</script>
	</body>
</html>
